COPY scripts/ci/apt-install /bin/apt-install

RUN apt-install \
	gnupg2 wget

# Add the cross compiler sources
RUN wget --no-check-certificate -O - https://www.ports.debian.org/archive_2023.key | apt-key add -

RUN echo "deb http://deb.debian.org/debian stable main" >> /etc/apt/sources.list && \
	echo "deb http://deb.debian.org/debian-ports sid main" >> /etc/apt/sources.list && \
	dpkg --add-architecture ${DEBIAN_ARCH}

RUN cat /etc/apt/sources.list

RUN apt-install \
	gcc-riscv64-linux-gnu:native \
	g++-riscv64-linux-gnu:native \
	dpkg-cross:native \
	libc6:${DEBIAN_ARCH}=2.37-5 \
	libc6-dev-${DEBIAN_ARCH}-cross		\
	libc6-${DEBIAN_ARCH}-cross		\
	libbz2-dev:${DEBIAN_ARCH}		\
	libexpat1-dev:${DEBIAN_ARCH}		\
	ncurses-dev:${DEBIAN_ARCH}		\
	libssl-dev:${DEBIAN_ARCH}		\
	protobuf-c-compiler			\
	protobuf-compiler			\
	python3-protobuf			\
	libnl-3-dev:${DEBIAN_ARCH}		\
	libprotobuf-dev:${DEBIAN_ARCH}		\
	libnet-dev:${DEBIAN_ARCH}		\
	libprotobuf-c-dev:${DEBIAN_ARCH}	\
	libcap-dev:${DEBIAN_ARCH}		\
	libaio-dev:${DEBIAN_ARCH}		\
	libnl-route-3-dev:${DEBIAN_ARCH}

ENV CROSS_COMPILE=${CROSS_TRIPLET}-				\
	CROSS_ROOT=/usr/${CROSS_TRIPLET}			\
	AS=/usr/bin/${CROSS_TRIPLET}-as				\
	AR=/usr/bin/${CROSS_TRIPLET}-ar				\
	CC=/usr/bin/${CROSS_TRIPLET}-gcc			\
	CPP=/usr/bin/${CROSS_TRIPLET}-cpp			\
	CXX=/usr/bin/${CROSS_TRIPLET}-g++			\
	LD=/usr/bin/${CROSS_TRIPLET}-ld				\
	FC=/usr/bin/${CROSS_TRIPLET}-gfortran

ENV PATH="${PATH}:${CROSS_ROOT}/bin"				\
	PKG_CONFIG_PATH=/usr/lib/${CROSS_TRIPLET}/pkgconfig

COPY . /criu
WORKDIR /criu

RUN	make mrproper && date && make -j $(nproc) zdtm && date
